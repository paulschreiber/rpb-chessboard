(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.kokopu=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){"use strict";exports.i18n=require("./src/i18n");exports.exception=require("./src/exception");var util=require("./src/util");exports.forEachSquare=util.forEachSquare;exports.squareColor=util.squareColor;exports.squareToCoordinates=util.squareToCoordinates;exports.coordinatesToSquare=util.coordinatesToSquare;exports.isMoveDescriptor=require("./src/movedescriptor").isInstanceOf;exports.Position=require("./src/position").Position;exports.Game=require("./src/game").Game;var pgn=require("./src/pgn");exports.pgnRead=pgn.pgnRead},{"./src/exception":3,"./src/game":4,"./src/i18n":5,"./src/movedescriptor":6,"./src/pgn":7,"./src/position":8,"./src/util":15}],2:[function(require,module,exports){"use strict";exports.WHITE=0;exports.BLACK=1;exports.KING=0;exports.QUEEN=1;exports.ROOK=2;exports.BISHOP=3;exports.KNIGHT=4;exports.PAWN=5;exports.WK=0;exports.BK=1;exports.WQ=2;exports.BQ=3;exports.WR=4;exports.BR=5;exports.WB=6;exports.BB=7;exports.WN=8;exports.BN=9;exports.WP=10;exports.BP=11;exports.EMPTY=-1;exports.INVALID=-2;exports.WHITE_WINS=0;exports.BLACK_WINS=1;exports.DRAW=2;exports.LINE=3;var COLOR_SYMBOL="wb";var PIECE_SYMBOL="kqrbnp";var RANK_SYMBOL="12345678";var FILE_SYMBOL="abcdefgh";var RESULT_SYMBOL=["1-0","0-1","1/2-1/2","*"];exports.colorToString=function(color){return COLOR_SYMBOL[color]};exports.pieceToString=function(piece){return PIECE_SYMBOL[piece]};exports.rankToString=function(rank){return RANK_SYMBOL[rank]};exports.fileToString=function(file){return FILE_SYMBOL[file]};exports.resultToString=function(result){return RESULT_SYMBOL[result]};exports.colorFromString=function(color){return COLOR_SYMBOL.indexOf(color)};exports.pieceFromString=function(piece){return PIECE_SYMBOL.indexOf(piece)};exports.rankFromString=function(rank){return RANK_SYMBOL.indexOf(rank)};exports.fileFromString=function(file){return FILE_SYMBOL.indexOf(file)};exports.resultFromString=function(result){return RESULT_SYMBOL.indexOf(result)};exports.squareToString=function(square){return FILE_SYMBOL[square%16]+RANK_SYMBOL[Math.floor(square/16)]};exports.squareFromString=function(square){if(!/^[a-h][1-8]$/.test(square)){return-1}var file=FILE_SYMBOL.indexOf(square[0]);var rank=RANK_SYMBOL.indexOf(square[1]);return rank*16+file};exports.coloredPieceToString=function(cp){return COLOR_SYMBOL[cp%2]+PIECE_SYMBOL[Math.floor(cp/2)]};exports.coloredPieceFromString=function(cp){if(!/^[wb][kqrbnp]$/.test(cp)){return-1}var color=COLOR_SYMBOL.indexOf(cp[0]);var piece=PIECE_SYMBOL.indexOf(cp[1]);return piece*2+color}},{}],3:[function(require,module,exports){"use strict";exports.IllegalArgument=function(fun){this.fun=fun};exports.InvalidFEN=function(fen,message){this.fen=fen;this.message=message;for(var i=2;i<arguments.length;++i){var re=new RegExp("%"+(i-1)+"\\$s");this.message=this.message.replace(re,arguments[i])}};exports.InvalidNotation=function(fen,notation,message){this.fen=fen;this.notation=notation;this.message=message;for(var i=3;i<arguments.length;++i){var re=new RegExp("%"+(i-2)+"\\$s");this.message=this.message.replace(re,arguments[i])}};exports.InvalidPGN=function(pgn,index,message){this.pgn=pgn;this.index=index;this.message=message;for(var i=3;i<arguments.length;++i){var re=new RegExp("%"+(i-2)+"\\$s");this.message=this.message.replace(re,arguments[i])}}},{}],4:[function(require,module,exports){"use strict";var bt=require("./basetypes");var exception=require("./exception");var i18n=require("./i18n");var Position=require("./position").Position;var Game=exports.Game=function(){this._playerName=[undefined,undefined];this._playerElo=[undefined,undefined];this._playerTitle=[undefined,undefined];this._event=undefined;this._round=undefined;this._date=undefined;this._site=undefined;this._annotator=undefined;this._result=bt.LINE;this._initialPosition=new Position;this._fullMoveNumber=1;this._mainVariation=new Variation(this,true)};Game.prototype.playerName=function(color,value){color=bt.colorFromString(color);if(color<0){throw new exception.IllegalArgument("Game#playerName()")}if(arguments.length===1){return this._playerName[color]}else{this._playerName[color]=value}};Game.prototype.playerElo=function(color,value){color=bt.colorFromString(color);if(color<0){throw new exception.IllegalArgument("Game#playerElo()")}if(arguments.length===1){return this._playerElo[color]}else{this._playerElo[color]=value}};Game.prototype.playerTitle=function(color,value){color=bt.colorFromString(color);if(color<0){throw new exception.IllegalArgument("Game#playerTitle()")}if(arguments.length===1){return this._playerTitle[color]}else{this._playerTitle[color]=value}};Game.prototype.event=function(value){if(arguments.length===0){return this._event}else{this._event=value}};Game.prototype.round=function(value){if(arguments.length===0){return this._round}else{this._round=value}};Game.prototype.date=function(value){if(arguments.length===0){return this._date}else if(value===undefined||value===null){this._date=undefined}else if(value instanceof Date){this._date=value}else if(typeof value==="object"&&typeof value.year==="number"&&typeof value.month==="number"){this._date={year:value.year,month:value.month}}else if(typeof value==="object"&&typeof value.year==="number"&&(value.month===undefined||value.month===null)){this._date={year:value.year}}else{throw new exception.IllegalArgument("Game#date()")}};Game.prototype.site=function(value){if(arguments.length===0){return this._site}else{this._site=value}};Game.prototype.annotator=function(value){if(arguments.length===0){return this._annotator}else{this._annotator=value}};Game.prototype.result=function(value){if(arguments.length===0){return bt.resultToString(this._result)}else{var result=bt.resultFromString(value);if(result<0){throw new exception.IllegalArgument("Game#result()")}this._result=result}};Game.prototype.initialPosition=function(initialPosition,fullMoveNumber){if(arguments.length===0){return this._initialPosition}else{if(!(initialPosition instanceof Position)){throw new exception.IllegalArgument("Game#initialPosition()")}if(arguments.length===1){fullMoveNumber=1}else if(typeof fullMoveNumber!=="number"){throw new exception.IllegalArgument("Game#initialPosition()")}this._initialPosition=initialPosition;this._fullMoveNumber=fullMoveNumber;this._mainVariation=new Variation(this,true)}};Game.prototype.mainVariation=function(){return this._mainVariation};function Node(parentVariation,previous,move){this._parentVariation=parentVariation;this._previous=previous;this._next=undefined;this._position=new Position(previous===undefined?parentVariation.initialPosition():previous.position());if(move==="--"){this._notation="--";if(!this._position.playNullMove()){throw new exception.InvalidNotation(this._position,"--",i18n.ILLEGAL_NULL_MOVE)}}else{var moveDescriptor=this._position.notation(move);this._notation=this._position.notation(moveDescriptor);this._position.play(moveDescriptor)}if(previous===undefined){this._fullMoveNumber=parentVariation.initialFullMoveNumber()}else{this._fullMoveNumber=previous._fullMoveNumber+(previous.position().turn()==="w"?1:0)}this._variations=[];this._nags={};this._tags={};this._comment=undefined;this._isLongComment=false}Node.prototype.notation=function(){return this._notation};Node.prototype.positionBefore=function(){return this._previous===undefined?this._parentVariation.initialPosition():this._previous.position()};Node.prototype.position=function(){return this._position};Node.prototype.fullMoveNumber=function(){return this._fullMoveNumber};Node.prototype.moveColor=function(){return this.positionBefore().turn()};Node.prototype.next=function(){return this._next};Node.prototype.variations=function(){return this._variations.slice(0)};Node.prototype.nags=function(){var res=[];for(var key in this._nags){if(this._nags[key]){res.push(key)}}return res};Node.prototype.hasNag=function(nag){return!!this._nags[nag]};Node.prototype.addNag=function(nag){this._nags[nag]=true};Node.prototype.removeNag=function(nag){delete this._nags[nag]};Node.prototype.tags=function(){var res=[];for(var key in this._tags){if(this._tags[key]!==undefined){res.push(key)}}return res};Node.prototype.tag=function(key,value){if(arguments.length===1){return this._tags[key]}else{this._tags[key]=value}};Node.prototype.comment=function(value,isLongComment){if(arguments.length===0){return this._comment}else{this._comment=value;this._isLongComment=isLongComment}};Node.prototype.isLongComment=function(){return this._isLongComment&&this._parentVariation.isLongVariation()};Node.prototype.play=function(move){this._next=new Node(this._parentVariation,this,move);return this._next};Node.prototype.addVariation=function(isLongVariation){this._variations.push(new Variation(this,isLongVariation));return this._variations[this._variations.length-1]};function Variation(parent,isLongVariation){this._parent=parent;this._first=undefined;this._isLongVariation=isLongVariation;this._nags={};this._tags={};this._comment=undefined;this._isLongComment=false}Variation.prototype.isLongVariation=function(){return this._isLongVariation&&(this._parent instanceof Game||this._parent._parentVariation.isLongVariation())};Variation.prototype.initialPosition=function(){return this._parent instanceof Game?this._parent.initialPosition():this._parent.positionBefore()};Variation.prototype.initialFullMoveNumber=function(){return this._parent._fullMoveNumber};Variation.prototype.first=function(){return this._first};Variation.prototype.nags=Node.prototype.nags;Variation.prototype.hasNag=Node.prototype.hasNag;Variation.prototype.addNag=Node.prototype.addNag;Variation.prototype.removeNag=Node.prototype.removeNag;Variation.prototype.tags=Node.prototype.tags;Variation.prototype.tag=Node.prototype.tag;Variation.prototype.comment=Node.prototype.comment;Variation.prototype.isLongComment=function(){return this._isLongComment&&this.isLongVariation()};Variation.prototype.play=function(move){this._first=new Node(this,undefined,move);return this._first}},{"./basetypes":2,"./exception":3,"./i18n":5,"./position":8}],5:[function(require,module,exports){"use strict";exports.ORDINALS=["1st","2nd","3rd","4th","5th","6th","7th","8th"];exports.WRONG_NUMBER_OF_FEN_FIELDS="A FEN string must contain exactly 6 space-separated fields.";exports.WRONG_NUMBER_OF_SUBFIELDS_IN_BOARD_FIELD="The 1st field of a FEN string must contain exactly 8 `/`-separated subfields.";exports.UNEXPECTED_CHARACTER_IN_BOARD_FIELD="Unexpected character in the 1st field of the FEN string: `%1$s`.";exports.UNEXPECTED_END_OF_SUBFIELD_IN_BOARD_FIELD="The %1$s subfield of the FEN string 1st field is unexpectedly short.";exports.INVALID_TURN_FIELD="The 2nd field of a FEN string must be either `w` or `b`.";exports.INVALID_CASTLING_FIELD="The 3rd field of a FEN string must be either `-` or a list of characters among `K`, `Q`, `k` and `q` (in this order).";exports.INVALID_EN_PASSANT_FIELD="The 4th field of a FEN string must be either `-` or a square from the 3rd or 6th rank where en-passant is allowed.";exports.WRONG_RANK_IN_EN_PASSANT_FIELD="The rank number indicated in the FEN string 4th field is inconsistent with respect to the 2nd field.";exports.INVALID_MOVE_COUNTING_FIELD="The %1$s field of a FEN string must be a number.";exports.INVALID_MOVE_NOTATION_SYNTAX="The syntax of the move notation is invalid.";exports.ILLEGAL_POSITION="The position is not legal.";exports.ILLEGAL_QUEEN_SIDE_CASTLING="Queen-side castling is not legal in the considered position.";exports.ILLEGAL_KING_SIDE_CASTLING="King-side castling is not legal in the considered position.";exports.NO_PIECE_CAN_MOVE_TO="No %1$s can move to %2$s.";exports.NO_PIECE_CAN_MOVE_TO_DISAMBIGUATION="No %1$s on the specified rank/file can move to %2$s.";exports.REQUIRE_DISAMBIGUATION="Cannot determine uniquely which %1$s is supposed to move to %2$s.";exports.WRONG_DISAMBIGUATION_SYMBOL="Wrong disambiguation symbol (expected: `%1$s`, observed: `%2$s`).";exports.TRYING_TO_CAPTURE_YOUR_OWN_PIECES="Capturing its own pieces is not legal.";exports.INVALID_CAPTURING_PAWN_MOVE="Invalid capturing pawn move.";exports.INVALID_NON_CAPTURING_PAWN_MOVE="Invalid non-capturing pawn move.";exports.NOT_SAFE_FOR_WHITE_KING="This move would put let the white king in check.";exports.NOT_SAFE_FOR_BLACK_KING="This move would put let the black king in check.";exports.MISSING_PROMOTION="A promoted piece must be specified for this move.";exports.MISSING_PROMOTION_SYMBOL="Character `=` is required to specify a promoted piece.";exports.INVALID_PROMOTED_PIECE="%1$s cannot be specified as a promoted piece.";exports.ILLEGAL_PROMOTION="Specifying a promoted piece is illegal for this move.";exports.ILLEGAL_NULL_MOVE="Cannot play a null-move in this position.";exports.MISSING_CAPTURE_SYMBOL="Capture symbol `x` is missing.";exports.INVALID_CAPTURE_SYMBOL="This move is not a capture move.";exports.WRONG_CHECK_CHECKMATE_SYMBOL="Wrong check/checkmate symbol (expected: `%1$s`, observed: `%2$s`).";exports.INVALID_PGN_TOKEN="Unrecognized character or group of characters.";exports.INVALID_MOVE_IN_PGN_TEXT="Invalid move (%1$s). %2$s";exports.INVALID_FEN_IN_PGN_TEXT="Invalid FEN string in the initial position header. %1$s";exports.UNEXPECTED_PGN_HEADER="Unexpected PGN game header.";exports.UNEXPECTED_BEGIN_OF_VARIATION="Unexpected begin of variation.";exports.UNEXPECTED_END_OF_VARIATION="Unexpected end of variation.";exports.UNEXPECTED_END_OF_GAME="Unexpected end of game: there are pending variations.";exports.UNEXPECTED_END_OF_TEXT="Unexpected end of text: there is a pending game.";exports.INVALID_GAME_INDEX="Game index %1$s is invalid (only %2$s game(s) found in the PGN data)."},{}],6:[function(require,module,exports){"use strict";var bt=require("./basetypes");var exception=require("./exception");var CASTLING_FLAG=1;var EN_PASSANT_FLAG=2;var CAPTURE_FLAG=4;var PROMOTION_FLAG=8;exports.make=function(from,to,color,movingPiece,capturedPiece){var flags=capturedPiece>=0?CAPTURE_FLAG:0;var movingColoredPiece=movingPiece*2+color;return new MoveDescriptor(flags,from,to,movingColoredPiece,movingColoredPiece,capturedPiece,-1,-1)};exports.makeCastling=function(from,to,rookFrom,rookTo,color){var movingKing=bt.KING*2+color;var movingRook=bt.ROOK*2+color;return new MoveDescriptor(CASTLING_FLAG,from,to,movingKing,movingKing,movingRook,rookFrom,rookTo)};exports.makeEnPassant=function(from,to,enPassantSquare,color){var flags=EN_PASSANT_FLAG|CAPTURE_FLAG;var movingPawn=bt.PAWN*2+color;var capturedPawn=bt.PAWN*2+1-color;return new MoveDescriptor(flags,from,to,movingPawn,movingPawn,capturedPawn,enPassantSquare,-1)};exports.makePromotion=function(from,to,color,promotion,capturedPiece){var flags=PROMOTION_FLAG|(capturedPiece>=0?CAPTURE_FLAG:0);var movingPawn=bt.PAWN*2+color;var finalPiece=promotion*2+color;return new MoveDescriptor(flags,from,to,movingPawn,finalPiece,capturedPiece,-1,-1)};function MoveDescriptor(flags,from,to,movingPiece,finalPiece,optionalPiece,optionalSquare1,optionalSquare2){this._type=flags;this._from=from;this._to=to;this._movingPiece=movingPiece;this._finalPiece=finalPiece;this._optionalPiece=optionalPiece;this._optionalSquare1=optionalSquare1;this._optionalSquare2=optionalSquare2}exports.isInstanceOf=function(obj){return obj instanceof MoveDescriptor};MoveDescriptor.prototype.isCastling=function(){return(this._type&CASTLING_FLAG)!==0};MoveDescriptor.prototype.isEnPassant=function(){return(this._type&EN_PASSANT_FLAG)!==0};MoveDescriptor.prototype.isCapture=function(){return(this._type&CAPTURE_FLAG)!==0};MoveDescriptor.prototype.isPromotion=function(){return(this._type&PROMOTION_FLAG)!==0};MoveDescriptor.prototype.from=function(){return bt.squareToString(this._from)};MoveDescriptor.prototype.to=function(){return bt.squareToString(this._to)};MoveDescriptor.prototype.color=function(){return bt.colorToString(this._movingPiece%2)};MoveDescriptor.prototype.movingPiece=function(){return bt.pieceToString(Math.floor(this._movingPiece/2))};MoveDescriptor.prototype.movingColoredPiece=function(){return bt.coloredPieceToString(this._movingPiece)};MoveDescriptor.prototype.capturedPiece=function(){if(!this.isCapture()){throw new exception.IllegalArgument("MoveDescriptor#capturedPiece()")}return bt.pieceToString(Math.floor(this._optionalPiece/2))};MoveDescriptor.prototype.capturedColoredPiece=function(){if(!this.isCapture()){throw new exception.IllegalArgument("MoveDescriptor#capturedColoredPiece()")}return bt.coloredPieceToString(this._optionalPiece)};MoveDescriptor.prototype.rookFrom=function(){if(!this.isCastling()){throw new exception.IllegalArgument("MoveDescriptor#rookFrom()")}return bt.squareToString(this._optionalSquare1)};MoveDescriptor.prototype.rookTo=function(){if(!this.isCastling()){throw new exception.IllegalArgument("MoveDescriptor#rookTo()")}return bt.squareToString(this._optionalSquare2)};MoveDescriptor.prototype.enPassantSquare=function(){if(!this.isEnPassant()){throw new exception.IllegalArgument("MoveDescriptor#enPassantSquare()")}return bt.squareToString(this._optionalSquare1)};MoveDescriptor.prototype.promotion=function(){if(!this.isPromotion()){throw new exception.IllegalArgument("MoveDescriptor#promotion()")}return bt.pieceToString(Math.floor(this._finalPiece/2))};MoveDescriptor.prototype.coloredPromotion=function(){if(!this.isPromotion()){throw new exception.IllegalArgument("MoveDescriptor#coloredPromotion()")}return bt.coloredPieceToString(this._finalPiece)};MoveDescriptor.prototype.toString=function(){var result=bt.squareToString(this._from)+bt.squareToString(this._to);if(this.isPromotion()){result+=this.promotion().toUpperCase()}return result}},{"./basetypes":2,"./exception":3}],7:[function(require,module,exports){"use strict";var exception=require("./exception");var i18n=require("./i18n");var Position=require("./position").Position;var Game=require("./game").Game;var SPECIAL_NAGS_LOOKUP={"!!":3,"!":1,"!?":5,"?!":6,"?":2,"??":4,"+-":18,"+/-":16,"+/=":14,"+=":14,"=":10,"~":13,inf:13,"=/+":15,"=+":15,"-/+":17,"-+":19};function parseHeaderValue(rawHeaderValue){return rawHeaderValue.replace(/\\([\\"\[\]])/g,"$1")}function parseCommentValue(rawComment){rawComment=rawComment.replace(/\\([\{\}\\])/g,"$1");var tags={};var comment=rawComment.replace(/\[%([a-zA-Z]+) ([^\[\]]+)\]/g,function(match,p1,p2){tags[p1]=p2;return" "});comment=comment.replace(/^\s+|\s+$/g,"").replace(/\s+/g," ");if(comment===""){comment=undefined}return{comment:comment,tags:tags}}var TOKEN_HEADER=1;var TOKEN_MOVE=2;var TOKEN_NAG=3;var TOKEN_COMMENT=4;var TOKEN_BEGIN_VARIATION=5;var TOKEN_END_VARIATION=6;var TOKEN_END_OF_GAME=7;function TokenStream(pgnString){this.text=pgnString;this._pos=0;this.emptyLineFound=false;this.token=0;this.tokenValue=null;this.tokenPos=0}TokenStream.prototype._skipBlanks=function(){var newLineCount=0;while(this._pos<this.text.length){var s=this.text.substr(this._pos);if(/^([ \f\t\v])+/.test(s)){this._pos+=RegExp.$1.length}else if(/^(\r?\n|\r)/.test(s)){this._pos+=RegExp.$1.length;++newLineCount}else{break}}this.emptyLineFound=newLineCount>=2};TokenStream.prototype.consumeToken=function(){this._skipBlanks();if(this._pos>=this.text.length){return false}var s=this.text.substr(this._pos);this.tokenPos=this._pos;if(/^(\[\s*(\w+)\s+\"((?:[^\\"\[\]]|\\[\\"\[\]])*)\"\s*\])/.test(s)){this._pos+=RegExp.$1.length;this.token=TOKEN_HEADER;this.tokenValue={key:RegExp.$2,value:parseHeaderValue(RegExp.$3)}}else if(/^((?:[1-9][0-9]*\s*\.(?:\.\.)?\s*)?((?:O-O-O|O-O|[KQRBN][a-h]?[1-8]?x?[a-h][1-8]|(?:[a-h]x?)?[a-h][1-8](?:=?[KQRBNP])?)[\+#]?|--))/.test(s)){this._pos+=RegExp.$1.length;this.token=TOKEN_MOVE;this.tokenValue=RegExp.$2}else if(/^(([!\?][!\?]?|\+\/?[\-=]|[\-=]\/?\+|=|inf|~)|\$([1-9][0-9]*))/.test(s)){this._pos+=RegExp.$1.length;this.token=TOKEN_NAG;this.tokenValue=RegExp.$3.length===0?SPECIAL_NAGS_LOOKUP[RegExp.$2]:parseInt(RegExp.$3,10)}else if(/^(\{((?:[^\{\}\\]|\\[\{\}\\])*)\})/.test(s)){this._pos+=RegExp.$1.length;this.token=TOKEN_COMMENT;this.tokenValue=parseCommentValue(RegExp.$2)}else if(/^(\()/.test(s)){this._pos+=RegExp.$1.length;this.token=TOKEN_BEGIN_VARIATION;this.tokenValue=null}else if(/^(\))/.test(s)){this._pos+=RegExp.$1.length;this.token=TOKEN_END_VARIATION;this.tokenValue=null}else if(/^(1\-0|0\-1|1\/2\-1\/2|\*)/.test(s)){this._pos+=RegExp.$1.length;this.token=TOKEN_END_OF_GAME;this.tokenValue=RegExp.$1}else{throw new exception.InvalidPGN(this.text,this._pos,i18n.INVALID_PGN_TOKEN)}return true};function parseNullableHeader(value){return value==="?"?undefined:value}function parseDateHeader(value){if(/^([0-9]{4})\.([0-9]{2})\.([0-9]{2})$/.test(value)){var year=RegExp.$1;var month=RegExp.$2;var day=RegExp.$3;year=parseInt(year,10);month=parseInt(month,10);day=parseInt(day,10);if(month>=1&&month<=12&&day>=1&&day<=31){return new Date(year,month-1,day)}}else if(/^([0-9]{4})\.([0-9]{2})\.\?\?$/.test(value)){var year=RegExp.$1;var month=parseInt(RegExp.$2,10);if(month>=1&&month<=12){return{year:parseInt(year,10),month:month}}}else if(/^([0-9]{4})(?:\.\?\?\.\?\?)?$/.test(value)){return{year:parseInt(RegExp.$1,10)}}return undefined}function processHeader(stream,game,key,value){value=value.trim();switch(key){case"White":game.playerName("w",parseNullableHeader(value));break;case"Black":game.playerName("b",parseNullableHeader(value));break;case"WhiteElo":game.playerElo("w",value);break;case"BlackElo":game.playerElo("b",value);break;case"WhiteTitle":game.playerTitle("w",value);break;case"BlackTitle":game.playerTitle("b",value);break;case"Event":game.event(parseNullableHeader(value));break;case"Round":game.round(parseNullableHeader(value));break;case"Date":game.date(parseDateHeader(value));break;case"Site":game.site(parseNullableHeader(value));break;case"Annotator":game.annotator(value);break;case"FEN":try{var position=new Position;var moveCounters=position.fen(value);game.initialPosition(position,moveCounters.fullMoveNumber)}catch(error){if(error instanceof exception.InvalidFEN){throw new exception.InvalidPGN(stream.text,stream.tokenPos,i18n.INVALID_FEN_IN_PGN_TEXT,error.message)}else{throw error}}break}}function doParseGame(stream){var game=null;var node=null;var nodeIsVariation=false;var nodeStack=[];while(stream.consumeToken()){if(game===null){game=new Game}if(stream.token!==TOKEN_HEADER&&node===null){node=game.mainVariation();nodeIsVariation=true}switch(stream.token){case TOKEN_HEADER:if(node!==null){throw new exception.InvalidPGN(stream.text,stream.tokenPos,i18n.UNEXPECTED_PGN_HEADER)}processHeader(stream,game,stream.tokenValue.key,stream.tokenValue.value);break;case TOKEN_MOVE:try{node=node.play(stream.tokenValue);nodeIsVariation=false}catch(error){if(error instanceof exception.InvalidNotation){throw new exception.InvalidPGN(stream.text,stream.tokenPos,i18n.INVALID_MOVE_IN_PGN_TEXT,error.notation,error.message)}else{throw error}}break;case TOKEN_NAG:node.addNag(stream.tokenValue);break;case TOKEN_COMMENT:for(var key in stream.tokenValue.tags){if(stream.tokenValue.tags[key]!==undefined){node.tag(key,stream.tokenValue.tags[key])}}node.comment(stream.tokenValue.comment,stream.emptyLineFound);break;case TOKEN_BEGIN_VARIATION:if(nodeIsVariation){throw new exception.InvalidPGN(stream.text,stream.tokenPos,i18n.UNEXPECTED_BEGIN_OF_VARIATION)}nodeStack.push(node);node=node.addVariation(stream.emptyLineFound);nodeIsVariation=true;break;case TOKEN_END_VARIATION:if(nodeStack.length===0){throw new exception.InvalidPGN(stream.text,stream.tokenPos,i18n.UNEXPECTED_END_OF_VARIATION)}node=nodeStack.pop();nodeIsVariation=false;break;case TOKEN_END_OF_GAME:if(nodeStack.length>0){throw new exception.InvalidPGN(stream.text,stream.tokenPos,i18n.UNEXPECTED_END_OF_GAME)}game.result(stream.tokenValue);return game}}if(game!==null){throw new exception.InvalidPGN(stream.text,stream.text.length,i18n.UNEXPECTED_END_OF_TEXT)}return null}function doSkipGame(stream){while(stream.consumeToken()){switch(stream.token){case TOKEN_END_OF_GAME:return true}}return false}exports.pgnRead=function(pgnString,gameIndex){var stream=new TokenStream(pgnString);if(arguments.length===1){var result=[];while(true){var currentGame=doParseGame(stream);if(currentGame===null){return result}result.push(currentGame)}}else{var gameCounter=0;while(gameCounter<gameIndex){if(doSkipGame(stream)){++gameCounter}else{throw new exception.InvalidPGN(pgnString,-1,i18n.INVALID_GAME_INDEX,gameIndex,gameCounter)}}var result=doParseGame(stream);if(result===null){throw new exception.InvalidPGN(pgnString,-1,i18n.INVALID_GAME_INDEX,gameIndex,gameCounter)}return result}}},{"./exception":3,"./game":4,"./i18n":5,"./position":8}],8:[function(require,module,exports){"use strict";var bt=require("./basetypes");var moveDescriptor=require("./movedescriptor");var exception=require("./exception");var impl=require("./private_position/impl");var fen=require("./private_position/fen");var attacks=require("./private_position/attacks");var legality=require("./private_position/legality");var moveGeneration=require("./private_position/movegeneration");var notation=require("./private_position/notation");var Position=exports.Position=function(){if(arguments.length===0||arguments[0]==="start"){this._impl=impl.makeInitial()}else if(arguments[0]==="empty"){this._impl=impl.makeEmpty()}else if(arguments[0]instanceof Position){this._impl=impl.makeCopy(arguments[0]._impl)}else if(typeof arguments[0]==="string"){this._impl=fen.parseFEN(arguments[0],false).position}else{throw new exception.IllegalArgument("Position()")}};Position.prototype.clear=function(){this._impl=impl.makeEmpty()};Position.prototype.reset=function(){this._impl=impl.makeInitial()};Position.prototype.ascii=function(){return fen.ascii(this._impl)};Position.prototype.fen=function(){if(arguments.length===0){return fen.getFEN(this._impl,0,1)}else if(arguments.length===1&&typeof arguments[0]==="object"){var fiftyMoveClock=typeof arguments[0].fiftyMoveClock==="number"?arguments[0].fiftyMoveClock:0;var fullMoveNumber=typeof arguments[0].fullMoveNumber==="number"?arguments[0].fullMoveNumber:1;return fen.getFEN(this._impl,fiftyMoveClock,fullMoveNumber)}else if(arguments.length===1&&typeof arguments[0]==="string"){var result=fen.parseFEN(arguments[0],false);this._impl=result.position;return{fiftyMoveClock:result.fiftyMoveClock,fullMoveNumber:result.fullMoveNumber}}else if(arguments.length>=2&&typeof arguments[0]==="string"&&typeof arguments[1]==="boolean"){var result=fen.parseFEN(arguments[0],arguments[1]);this._impl=result.position;return{fiftyMoveClock:result.fiftyMoveClock,fullMoveNumber:result.fullMoveNumber}}else{throw new exception.IllegalArgument("Position#fen()")}};Position.prototype.square=function(square,value){square=bt.squareFromString(square);if(square<0){throw new exception.IllegalArgument("Position#square()")}if(arguments.length===1){var cp=this._impl.board[square];return cp<0?"-":bt.coloredPieceToString(cp)}else if(value==="-"){this._impl.board[square]=bt.EMPTY;this._impl.legal=null}else{var cp=bt.coloredPieceFromString(value);if(cp<0){throw new exception.IllegalArgument("Position#square()")}this._impl.board[square]=cp;this._impl.legal=null}};Position.prototype.turn=function(value){if(arguments.length===0){return bt.colorToString(this._impl.turn)}else{var turn=bt.colorFromString(value);if(turn<0){throw new exception.IllegalArgument("Position#turn()")}this._impl.turn=turn;this._impl.legal=null}};Position.prototype.castling=function(castle,value){if(!/^[wb][qk]$/.test(castle)){throw new exception.IllegalArgument("Position#castling()")}var color=bt.colorFromString(castle[0]);var file=castle[1]==="k"?7:0;if(arguments.length===1){return(this._impl.castling[color]&1<<file)!==0}else if(value){this._impl.castling[color]|=1<<file;this._impl.legal=null}else{this._impl.castling[color]&=~(1<<file);this._impl.legal=null}};Position.prototype.enPassant=function(value){if(arguments.length===0){return this._impl.enPassant<0?"-":bt.fileToString(this._impl.enPassant)}else if(value==="-"){this._impl.enPassant=-1;this._impl.legal=null}else{var enPassant=bt.fileFromString(value);if(enPassant<0){throw new exception.IllegalArgument("Position#enPassant()")}this._impl.enPassant=enPassant;this._impl.legal=null}};Position.prototype.isAttacked=function(square,byWho){square=bt.squareFromString(square);byWho=bt.colorFromString(byWho);if(square<0||byWho<0){throw new exception.IllegalArgument("Position#isAttacked()")}return attacks.isAttacked(this._impl,square,byWho)};Position.prototype.getAttacks=function(square,byWho){square=bt.squareFromString(square);byWho=bt.colorFromString(byWho);if(square<0||byWho<0){throw new exception.IllegalArgument("Position#getAttacks()")}return attacks.getAttacks(this._impl,square,byWho).map(bt.squareToString)};Position.prototype.isLegal=function(){return legality.isLegal(this._impl)};Position.prototype.kingSquare=function(color){color=bt.colorFromString(color);if(color<0){throw new exception.IllegalArgument("Position#kingSquare()")}legality.refreshLegalFlagAndKingSquares(this._impl);var square=this._impl.king[color];return square<0?"-":bt.squareToString(square)};Position.prototype.isCheck=function(){return moveGeneration.isCheck(this._impl)};Position.prototype.isCheckmate=function(){return moveGeneration.isCheckmate(this._impl)};Position.prototype.isStalemate=function(){return moveGeneration.isStalemate(this._impl)};Position.prototype.hasMove=function(){return moveGeneration.hasMove(this._impl)};Position.prototype.moves=function(){return moveGeneration.moves(this._impl)};Position.prototype.isMoveLegal=function(from,to){from=bt.squareFromString(from);to=bt.squareFromString(to);if(from<0||to<0){throw new exception.IllegalArgument("Position#isMoveLegal()")}var result=moveGeneration.isMoveLegal(this._impl,from,to);if(typeof result==="function"){var builder=function(promotion){promotion=bt.pieceFromString(promotion);if(promotion>=0){var builtMoveDescriptor=result(promotion);if(builtMoveDescriptor){return builtMoveDescriptor}}throw new exception.IllegalArgument("Position#isMoveLegal()")};builder.needPromotion=true;return builder}else{return result}};Position.prototype.play=function(move){if(typeof move==="string"){try{moveGeneration.play(this._impl,notation.parseNotation(this._impl,move,false));return true}catch(err){if(err instanceof exception.InvalidNotation){return false}else{throw err}}}else if(moveDescriptor.isInstanceOf(move)){moveGeneration.play(this._impl,move);return true}else{throw new exception.IllegalArgument("Position#play()")}};Position.prototype.isNullMoveLegal=function(){return moveGeneration.isNullMoveLegal(this._impl)};Position.prototype.playNullMove=function(){return moveGeneration.playNullMove(this._impl)};Position.prototype.notation=function(){if(arguments.length===1&&moveDescriptor.isInstanceOf(arguments[0])){return notation.getNotation(this._impl,arguments[0])}else if(arguments.length===1&&typeof arguments[0]==="string"){return notation.parseNotation(this._impl,arguments[0],false)}else if(arguments.length>=2&&typeof arguments[0]==="string"&&typeof arguments[1]==="boolean"){return notation.parseNotation(this._impl,arguments[0],arguments[1])}else{throw new exception.IllegalArgument("Position#notation()")}}},{"./basetypes":2,"./exception":3,"./movedescriptor":6,"./private_position/attacks":9,"./private_position/fen":10,"./private_position/impl":11,"./private_position/legality":12,"./private_position/movegeneration":13,"./private_position/notation":14}],9:[function(require,module,exports){"use strict";var bt=require("../basetypes");var ATTACK_DIRECTIONS=exports.ATTACK_DIRECTIONS=[[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-16,-1,1,16],[-16,-1,1,16],[-17,-15,15,17],[-17,-15,15,17],[-33,-31,-18,-14,14,18,31,33],[-33,-31,-18,-14,14,18,31,33],[15,17],[-17,-15]];exports.isAttacked=function(position,square,attackerColor){return isAttackedByNonSliding(position,square,bt.KING*2+attackerColor)||isAttackedByNonSliding(position,square,bt.KNIGHT*2+attackerColor)||isAttackedByNonSliding(position,square,bt.PAWN*2+attackerColor)||isAttackedBySliding(position,square,bt.ROOK*2+attackerColor,bt.QUEEN*2+attackerColor)||isAttackedBySliding(position,square,bt.BISHOP*2+attackerColor,bt.QUEEN*2+attackerColor)};function isAttackedByNonSliding(position,square,nonSlidingAttacker){var directions=ATTACK_DIRECTIONS[nonSlidingAttacker];for(var i=0;i<directions.length;++i){var sq=square-directions[i];if((sq&136)===0&&position.board[sq]===nonSlidingAttacker){return true}}return false}function isAttackedBySliding(position,square,slidingAttacker,queenAttacker){var directions=ATTACK_DIRECTIONS[slidingAttacker];for(var i=0;i<directions.length;++i){var sq=square;while(true){sq-=directions[i];if((sq&136)===0){var cp=position.board[sq];if(cp===bt.EMPTY){continue}else if(cp===slidingAttacker||cp===queenAttacker){return true}}break}}return false}exports.getAttacks=function(position,square,attackerColor){var result=[];findNonSlidingAttacks(position,square,result,bt.KING*2+attackerColor);findNonSlidingAttacks(position,square,result,bt.KNIGHT*2+attackerColor);findNonSlidingAttacks(position,square,result,bt.PAWN*2+attackerColor);findSlidingAttacks(position,square,result,bt.ROOK*2+attackerColor,bt.QUEEN*2+attackerColor);findSlidingAttacks(position,square,result,bt.BISHOP*2+attackerColor,bt.QUEEN*2+attackerColor);return result};function findNonSlidingAttacks(position,square,result,nonSlidingAttacker){var directions=ATTACK_DIRECTIONS[nonSlidingAttacker];for(var i=0;i<directions.length;++i){var sq=square-directions[i];if((sq&136)===0&&position.board[sq]===nonSlidingAttacker){result.push(sq)}}}function findSlidingAttacks(position,square,result,slidingAttacker,queenAttacker){var directions=ATTACK_DIRECTIONS[slidingAttacker];for(var i=0;i<directions.length;++i){var sq=square;while(true){sq-=directions[i];if((sq&136)===0){var cp=position.board[sq];if(cp===bt.EMPTY){continue}else if(cp===slidingAttacker||cp===queenAttacker){result.push(sq)}}break}}}},{"../basetypes":2}],10:[function(require,module,exports){"use strict";var bt=require("../basetypes");var exception=require("../exception");var i18n=require("../i18n");var impl=require("./impl");var FEN_PIECE_SYMBOL="KkQqRrBbNnPp";exports.ascii=function(position){var result="+---+---+---+---+---+---+---+---+\n";for(var r=7;r>=0;--r){for(var f=0;f<8;++f){var cp=position.board[r*16+f];result+="| "+(cp<0?" ":FEN_PIECE_SYMBOL[cp])+" "}result+="|\n";result+="+---+---+---+---+---+---+---+---+\n"}result+=bt.colorToString(position.turn)+" "+castlingToString(position)+" "+enPassantToString(position);return result};exports.getFEN=function(position,fiftyMoveClock,fullMoveNumber){var result="";for(var r=7;r>=0;--r){var emptyCount=0;for(var f=0;f<8;++f){var cp=position.board[r*16+f];if(cp<0){++emptyCount}else{if(emptyCount>0){result+=emptyCount;emptyCount=0}result+=FEN_PIECE_SYMBOL[cp]}}if(emptyCount>0){result+=emptyCount}if(r>0){result+="/"}}result+=" "+bt.colorToString(position.turn)+" "+castlingToString(position)+" "+enPassantToString(position);result+=" "+fiftyMoveClock+" "+fullMoveNumber;return result};function castlingToString(position){var result="";if(position.castling[bt.WHITE]&1<<7){result+="K"}if(position.castling[bt.WHITE]&1<<0){result+="Q"}if(position.castling[bt.BLACK]&1<<7){result+="k"}if(position.castling[bt.BLACK]&1<<0){result+="q"}return result===""?"-":result}function enPassantToString(position){return position.enPassant<0?"-":bt.fileToString(position.enPassant)+(position.turn===bt.WHITE?"6":"3")}exports.parseFEN=function(fen,strict){fen=fen.replace(/^\s+|\s+$/g,"");var fields=fen.split(/\s+/);if(fields.length!==6){throw new exception.InvalidFEN(fen,i18n.WRONG_NUMBER_OF_FEN_FIELDS)}var rankFields=fields[0].split("/");if(rankFields.length!==8){throw new exception.InvalidFEN(fen,i18n.WRONG_NUMBER_OF_SUBFIELDS_IN_BOARD_FIELD)}var position=impl.makeEmpty();position.legal=null;for(var r=7;r>=0;--r){var rankField=rankFields[7-r];var i=0;var f=0;while(i<rankField.length&&f<8){var s=rankField[i];var cp=FEN_PIECE_SYMBOL.indexOf(s);if(/^[1-8]$/.test(s)){f+=parseInt(s,10)}else if(cp>=0){position.board[r*16+f]=cp;++f}else{throw new exception.InvalidFEN(fen,i18n.UNEXPECTED_CHARACTER_IN_BOARD_FIELD,s)}++i}if(i!==rankField.length||f!==8){throw new exception.InvalidFEN(fen,i18n.UNEXPECTED_END_OF_SUBFIELD_IN_BOARD_FIELD,i18n.ORDINALS[7-r])}}position.turn=bt.colorFromString(fields[1]);if(position.turn<0){throw new exception.InvalidFEN(fen,i18n.INVALID_TURN_FIELD)}position.castling=castlingFromString(fields[2],strict);if(position.castling===null){throw new exception.InvalidFEN(fen,i18n.INVALID_CASTLING_FIELD)}var enPassantField=fields[3];if(enPassantField!=="-"){if(!/^[a-h][36]$/.test(enPassantField)){throw new exception.InvalidFEN(fen,i18n.INVALID_EN_PASSANT_FIELD)}if(strict&&(enPassantField[1]==="3"&&position.turn===bt.WHITE||enPassantField[1]==="6"&&position.turn===bt.BLACK)){throw new exception.InvalidFEN(fen,i18n.WRONG_RANK_IN_EN_PASSANT_FIELD)}position.enPassant=bt.fileFromString(enPassantField[0])}var moveCountingRegExp=strict?/^(?:0|[1-9][0-9]*)$/:/^[0-9]+$/;if(!moveCountingRegExp.test(fields[4])){throw new exception.InvalidFEN(fen,i18n.INVALID_MOVE_COUNTING_FIELD,i18n.ORDINALS[4])}if(!moveCountingRegExp.test(fields[5])){throw new exception.InvalidFEN(fen,i18n.INVALID_MOVE_COUNTING_FIELD,i18n.ORDINALS[5])}return{position:position,fiftyMoveClock:parseInt(fields[4],10),fullMoveNumber:parseInt(fields[5],10)}};function castlingFromString(castling,strict){var res=[0,0];if(castling==="-"){return res}if(!(strict?/^K?Q?k?q?$/:/^[KQkq]*$/).test(castling)){return null}if(castling.indexOf("K")>=0){res[bt.WHITE]|=1<<7}if(castling.indexOf("Q")>=0){res[bt.WHITE]|=1<<0}if(castling.indexOf("k")>=0){res[bt.BLACK]|=1<<7}if(castling.indexOf("q")>=0){res[bt.BLACK]|=1<<0}return res}},{"../basetypes":2,"../exception":3,"../i18n":5,"./impl":11}],11:[function(require,module,exports){"use strict";var bt=require("../basetypes");var EMPTY=bt.EMPTY;var INVALID=bt.INVALID;exports.makeEmpty=function(){return{board:[EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY],turn:bt.WHITE,castling:[0,0],enPassant:-1,legal:false,king:[-1,-1]}};exports.makeInitial=function(){return{board:[bt.WR,bt.WN,bt.WB,bt.WQ,bt.WK,bt.WB,bt.WN,bt.WR,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.BR,bt.BN,bt.BB,bt.BQ,bt.BK,bt.BB,bt.BN,bt.BR],turn:bt.WHITE,castling:[129,129],enPassant:-1,legal:true,king:[4,116]}};exports.makeCopy=function(position){return{board:position.board.slice(),turn:position.turn,castling:position.castling.slice(),enPassant:position.enPassant,legal:position.legal,king:position.king.slice()}}},{"../basetypes":2}],12:[function(require,module,exports){"use strict";var bt=require("../basetypes");var attacks=require("./attacks");exports.isLegal=function(position){refreshLegalFlagAndKingSquares(position);return position.legal};var refreshLegalFlagAndKingSquares=exports.refreshLegalFlagAndKingSquares=function(position){if(position.legal!==null){return}position.legal=false;refreshKingSquare(position,bt.WHITE);refreshKingSquare(position,bt.BLACK);if(position.king[bt.WHITE]<0||position.king[bt.BLACK]<0){return}if(attacks.isAttacked(position,position.king[1-position.turn],position.turn)){return}for(var c=0;c<8;++c){var cp1=position.board[c];var cp8=position.board[112+c];if(cp1===bt.WP||cp8===bt.WP||cp1===bt.BP||cp8===bt.BP){return}}for(var color=0;color<2;++color){var skipOO=(position.castling[color]&128)===0;var skipOOO=(position.castling[color]&1)===0;var rookHOK=skipOO||position.board[7+112*color]===bt.ROOK*2+color;var rookAOK=skipOOO||position.board[0+112*color]===bt.ROOK*2+color;var kingOK=skipOO&&skipOOO||position.board[4+112*color]===bt.KING*2+color;if(!(kingOK&&rookAOK&&rookHOK)){return}}if(position.enPassant>=0){var square2=(6-position.turn*5)*16+position.enPassant;var square3=(5-position.turn*3)*16+position.enPassant;var square4=(4-position.turn)*16+position.enPassant;if(!(position.board[square2]===bt.EMPTY&&position.board[square3]===bt.EMPTY&&position.board[square4]===bt.PAWN*2+1-position.turn)){return}}position.legal=true};function refreshKingSquare(position,color){var target=bt.KING*2+color;position.king[color]=-1;for(var sq=0;sq<120;sq+=(sq&7)===7?9:1){if(position.board[sq]===target){if(position.king[color]<0){position.king[color]=sq}else{position.king[color]=-1;return}}}}},{"../basetypes":2,"./attacks":9}],13:[function(require,module,exports){"use strict";var bt=require("../basetypes");var moveDescriptor=require("../movedescriptor");var attacks=require("./attacks");var legality=require("./legality");var DISPLACEMENT_LOOKUP=[204,0,0,0,0,0,0,60,0,0,0,0,0,0,204,0,0,204,0,0,0,0,0,60,0,0,0,0,0,204,0,0,0,0,204,0,0,0,0,60,0,0,0,0,204,0,0,0,0,0,0,204,0,0,0,60,0,0,0,204,0,0,0,0,0,0,0,0,204,0,0,60,0,0,204,0,0,0,0,0,0,0,0,0,0,204,768,60,768,204,0,0,0,0,0,0,0,0,0,0,0,768,2255,2111,2255,768,0,0,0,0,0,0,60,60,60,60,60,60,63,0,63,60,60,60,60,60,60,0,0,0,0,0,0,768,1231,1087,1231,768,0,0,0,0,0,0,0,0,0,0,0,204,768,60,768,204,0,0,0,0,0,0,0,0,0,0,204,0,0,60,0,0,204,0,0,0,0,0,0,0,0,204,0,0,0,60,0,0,0,204,0,0,0,0,0,0,204,0,0,0,0,60,0,0,0,0,204,0,0,0,0,204,0,0,0,0,0,60,0,0,0,0,0,204,0,0,204,0,0,0,0,0,0,60,0,0,0,0,0,0,204,0];var SLIDING_DIRECTION=[-17,0,0,0,0,0,0,-16,0,0,0,0,0,0,-15,0,0,-17,0,0,0,0,0,-16,0,0,0,0,0,-15,0,0,0,0,-17,0,0,0,0,-16,0,0,0,0,-15,0,0,0,0,0,0,-17,0,0,0,-16,0,0,0,-15,0,0,0,0,0,0,0,0,-17,0,0,-16,0,0,-15,0,0,0,0,0,0,0,0,0,0,-17,0,-16,0,-15,0,0,0,0,0,0,0,0,0,0,0,0,-17,-16,-15,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,15,16,17,0,0,0,0,0,0,0,0,0,0,0,0,15,0,16,0,17,0,0,0,0,0,0,0,0,0,0,15,0,0,16,0,0,17,0,0,0,0,0,0,0,0,15,0,0,0,16,0,0,0,17,0,0,0,0,0,0,15,0,0,0,0,16,0,0,0,0,17,0,0,0,0,15,0,0,0,0,0,16,0,0,0,0,0,17,0,0,15,0,0,0,0,0,0,16,0,0,0,0,0,0,17,0];exports.isCheck=function(position){return legality.isLegal(position)&&attacks.isAttacked(position,position.king[position.turn],1-position.turn)};exports.isCheckmate=function(position){return legality.isLegal(position)&&!hasMove(position)&&attacks.isAttacked(position,position.king[position.turn],1-position.turn)};exports.isStalemate=function(position){return legality.isLegal(position)&&!hasMove(position)&&!attacks.isAttacked(position,position.king[position.turn],1-position.turn)};var hasMove=exports.hasMove=function(position){function MoveFound(){}try{generateMoves(position,function(descriptor){if(descriptor){throw new MoveFound}});return false}catch(err){if(err instanceof MoveFound){return true}else{throw err}}};exports.moves=function(position){var res=[];generateMoves(position,function(descriptor,generatePromotions){if(descriptor){if(generatePromotions){res.push(moveDescriptor.makePromotion(descriptor._from,descriptor._to,position.turn,bt.QUEEN,descriptor._optionalPiece));res.push(moveDescriptor.makePromotion(descriptor._from,descriptor._to,position.turn,bt.ROOK,descriptor._optionalPiece));res.push(moveDescriptor.makePromotion(descriptor._from,descriptor._to,position.turn,bt.BISHOP,descriptor._optionalPiece));res.push(moveDescriptor.makePromotion(descriptor._from,descriptor._to,position.turn,bt.KNIGHT,descriptor._optionalPiece))}else{res.push(descriptor)}}});return res};function generateMoves(position,fun){if(!legality.isLegal(position)){return}for(var from=0;from<120;from+=(from&7)===7?9:1){var fromContent=position.board[from];var movingPiece=Math.floor(fromContent/2);if(fromContent<0||fromContent%2!==position.turn){continue}if(movingPiece===bt.PAWN){var attackDirections=attacks.ATTACK_DIRECTIONS[fromContent];for(var i=0;i<attackDirections.length;++i){var to=from+attackDirections[i];if((to&136)===0){var toContent=position.board[to];if(toContent>=0&&toContent%2!==position.turn){fun(isKingSafeAfterMove(position,from,to,-1),to<8||to>=112)}else if(toContent<0&&to===(5-position.turn*3)*16+position.enPassant){fun(isKingSafeAfterMove(position,from,to,(4-position.turn)*16+position.enPassant),false)}}}var moveDirection=16-position.turn*32;var to=from+moveDirection;if(position.board[to]<0){fun(isKingSafeAfterMove(position,from,to,-1),to<8||to>=112);var firstSquareOfRow=(1+position.turn*5)*16;if(from>=firstSquareOfRow&&from<firstSquareOfRow+8){to+=moveDirection;if(position.board[to]<0){fun(isKingSafeAfterMove(position,from,to,-1),false)}}}}else if(movingPiece===bt.KNIGHT||movingPiece===bt.KING){var directions=attacks.ATTACK_DIRECTIONS[fromContent];for(var i=0;i<directions.length;++i){var to=from+directions[i];if((to&136)===0){var toContent=position.board[to];if(toContent<0||toContent%2!==position.turn){fun(isKingSafeAfterMove(position,from,to,-1),false)}}}}else{var directions=attacks.ATTACK_DIRECTIONS[fromContent];for(var i=0;i<directions.length;++i){for(var to=from+directions[i];(to&136)===0;to+=directions[i]){var toContent=position.board[to];if(toContent<0||toContent%2!==position.turn){fun(isKingSafeAfterMove(position,from,to,-1),false)}if(toContent>=0){break}}}}if(movingPiece===bt.KING&&position.castling[position.turn]!==0){var to=[from-2,from+2];for(var i=0;i<to.length;++i){fun(isCastlingLegal(position,from,to[i]),false)}}}}var isKingSafeAfterMove=exports.isKingSafeAfterMove=function(position,from,to,enPassantSquare){var fromContent=position.board[from];var toContent=position.board[to];var movingPiece=Math.floor(fromContent/2);position.board[to]=fromContent;position.board[from]=bt.EMPTY;if(enPassantSquare>=0){position.board[enPassantSquare]=bt.EMPTY}var kingSquare=movingPiece===bt.KING?to:position.king[position.turn];var kingIsInCheck=attacks.isAttacked(position,kingSquare,1-position.turn);position.board[from]=fromContent;position.board[to]=toContent;if(enPassantSquare>=0){position.board[enPassantSquare]=bt.PAWN*2+1-position.turn}if(kingIsInCheck){return false}else{if(enPassantSquare>=0){return moveDescriptor.makeEnPassant(from,to,enPassantSquare,position.turn)}else{return moveDescriptor.make(from,to,position.turn,movingPiece,toContent)}}};var isCastlingLegal=exports.isCastlingLegal=function(position,from,to){var column=from<to?7:0;if((position.castling[position.turn]&1<<column)===0){return false}var rookFrom=column+position.turn*112;var rookTo=(from+to)/2;var offset=from<rookFrom?1:-1;for(var sq=from+offset;sq!==rookFrom;sq+=offset){if(position.board[sq]!==bt.EMPTY){return false}}var byWho=1-position.turn;if(attacks.isAttacked(position,from,byWho)||attacks.isAttacked(position,to,byWho)||attacks.isAttacked(position,rookTo,byWho)){return false}return moveDescriptor.makeCastling(from,to,rookFrom,rookTo,position.turn)};exports.isMoveLegal=function(position,from,to){if(!legality.isLegal(position)){return false}var fromContent=position.board[from];var toContent=position.board[to];var movingPiece=Math.floor(fromContent/2);if(fromContent<0||fromContent%2!==position.turn){return false}var displacement=to-from+119;var enPassantSquare=-1;var isTwoSquarePawnMove=false;var isPromotion=movingPiece===bt.PAWN&&(to<8||to>=112);if((DISPLACEMENT_LOOKUP[displacement]&1<<fromContent)===0){if(movingPiece===bt.PAWN&&displacement===151-position.turn*64){var firstSquareOfRow=(1+position.turn*5)*16;if(from<firstSquareOfRow||from>=firstSquareOfRow+8){return false}isTwoSquarePawnMove=true}else if(movingPiece===bt.KING&&(displacement===117||displacement===121)){return isCastlingLegal(position,from,to)}else{return false}}if(movingPiece===bt.PAWN){if(displacement===135-position.turn*32||isTwoSquarePawnMove){if(toContent!==bt.EMPTY){return false}}else if(toContent===bt.EMPTY){if(position.enPassant<0||to!==(5-position.turn*3)*16+position.enPassant){return false}enPassantSquare=(4-position.turn)*16+position.enPassant}else{if(toContent%2===position.turn){return false}}}else{if(toContent>=0&&toContent%2===position.turn){return false}}if(movingPiece===bt.BISHOP||movingPiece===bt.ROOK||movingPiece===bt.QUEEN){var direction=SLIDING_DIRECTION[displacement];for(var sq=from+direction;sq!==to;sq+=direction){if(position.board[sq]!==bt.EMPTY){return false}}}else if(isTwoSquarePawnMove){if(position.board[(from+to)/2]!==bt.EMPTY){return false}}var descriptor=isKingSafeAfterMove(position,from,to,enPassantSquare);return descriptor&&isPromotion?function(promotion){if(promotion!==bt.PAWN&&promotion!==bt.KING){return moveDescriptor.makePromotion(descriptor._from,descriptor._to,descriptor._movingPiece%2,promotion,descriptor._optionalPiece)}return false}:descriptor};exports.play=function(position,descriptor){if(descriptor.isEnPassant()){position.board[descriptor._optionalSquare1]=bt.EMPTY}else if(descriptor.isCastling()){position.board[descriptor._optionalSquare1]=bt.EMPTY;position.board[descriptor._optionalSquare2]=descriptor._optionalPiece}position.board[descriptor._to]=descriptor._finalPiece;position.board[descriptor._from]=bt.EMPTY;var movingPiece=Math.floor(descriptor._movingPiece/2);if(movingPiece===bt.KING){position.castling[position.turn]=0}if(descriptor._from<8){position.castling[bt.WHITE]&=~(1<<descriptor._from)}if(descriptor._to<8){position.castling[bt.WHITE]&=~(1<<descriptor._to)}if(descriptor._from>=112){position.castling[bt.BLACK]&=~(1<<descriptor._from%16)}if(descriptor._to>=112){position.castling[bt.BLACK]&=~(1<<descriptor._to%16)}position.enPassant=-1;if(movingPiece===bt.PAWN&&Math.abs(descriptor._from-descriptor._to)===32){var otherPawn=descriptor._movingPiece^1;var squareBefore=descriptor._to-1;var squareAfter=descriptor._to+1;if((squareBefore&136)===0&&position.board[squareBefore]===otherPawn||(squareAfter&136)===0&&position.board[squareAfter]===otherPawn){position.enPassant=descriptor._to%16}}if(movingPiece===bt.KING){position.king[position.turn]=descriptor._to}position.turn=1-position.turn};var isNullMoveLegal=exports.isNullMoveLegal=function(position){return legality.isLegal(position)&&!attacks.isAttacked(position,position.king[position.turn],1-position.turn)};exports.playNullMove=function(position){if(isNullMoveLegal(position)){position.turn=1-position.turn;position.enPassant=-1;return true}else{return false}}},{"../basetypes":2,"../movedescriptor":6,"./attacks":9,"./legality":12}],14:[function(require,module,exports){"use strict";var bt=require("../basetypes");var moveDescriptor=require("../movedescriptor");var exception=require("../exception");var i18n=require("../i18n");var impl=require("./impl");var fen=require("./fen");var attacks=require("./attacks");var legality=require("./legality");var moveGeneration=require("./movegeneration");exports.getNotation=function(position,descriptor){var res="";if(descriptor.isCastling()){res=descriptor._from<descriptor._to?"O-O":"O-O-O"}else if(Math.floor(descriptor._movingPiece/2)===bt.PAWN){if(descriptor.isCapture()){res+=bt.fileToString(descriptor._from%16)+"x"}res+=bt.squareToString(descriptor._to);if(descriptor.isPromotion()){res+="="+bt.pieceToString(Math.floor(descriptor._finalPiece/2)).toUpperCase()}}else{res+=bt.pieceToString(Math.floor(descriptor._movingPiece/2)).toUpperCase();res+=getDisambiguationSymbol(position,descriptor._from,descriptor._to);if(descriptor.isCapture()){res+="x"}res+=bt.squareToString(descriptor._to)}res+=getCheckCheckmateSymbol(position,descriptor);return res};function getCheckCheckmateSymbol(position,descriptor){var nextPosition=impl.makeCopy(position);moveGeneration.play(nextPosition,descriptor);return moveGeneration.isCheck(nextPosition)?moveGeneration.hasMove(nextPosition)?"+":"#":""}function getDisambiguationSymbol(position,from,to){var attackers=attacks.getAttacks(position,to,position.turn).filter(function(sq){return position.board[sq]===position.board[from]});if(attackers.length<2){return""}var foundNotPined=false;var foundOnSameRank=false;var foundOnSameFile=false;var rankFrom=Math.floor(from/16);var fileFrom=from%16;for(var i=0;i<attackers.length;++i){var sq=attackers[i];if(sq===from||isPinned(position,sq)){continue}foundNotPined=true;if(rankFrom===Math.floor(sq/16)){foundOnSameRank=true}if(fileFrom===sq%16){foundOnSameFile=true}}if(foundOnSameFile){return foundOnSameRank?bt.squareToString(from):bt.rankToString(rankFrom)}else{return foundNotPined?bt.fileToString(fileFrom):""}}function isPinned(position,sq){var content=position.board[sq];position.board[sq]=bt.EMPTY;var result=attacks.isAttacked(position,position.king[position.turn],1-position.turn);position.board[sq]=content;return result}exports.parseNotation=function(position,notation,strict){var m=/^(?:(O-O-O)|(O-O)|([KQRBN])([a-h])?([1-8])?(x)?([a-h][1-8])|(?:([a-h])(x)?)?([a-h][1-8])(?:(=)?([KQRBNP]))?)([\+#])?$/.exec(notation);if(m===null){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_MOVE_NOTATION_SYNTAX)}if(!legality.isLegal(position)){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_POSITION)}var descriptor=null;if(m[1]||m[2]){var from=position.king[position.turn];var to=from+(m[2]?2:-2);descriptor=moveGeneration.isCastlingLegal(position,from,to);if(!descriptor){var message=m[2]?i18n.ILLEGAL_KING_SIDE_CASTLING:i18n.ILLEGAL_QUEEN_SIDE_CASTLING;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,message)}}else if(m[3]){var movingPiece=bt.pieceFromString(m[3].toLowerCase());var to=bt.squareFromString(m[7]);var toContent=position.board[to];if(toContent>=0&&toContent%2===position.turn){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.TRYING_TO_CAPTURE_YOUR_OWN_PIECES)}var attackers=attacks.getAttacks(position,to,position.turn).filter(function(sq){return position.board[sq]===movingPiece*2+position.turn});if(m[4]){var fileFrom=bt.fileFromString(m[4]);attackers=attackers.filter(function(sq){return sq%16===fileFrom})}if(m[5]){var rankFrom=bt.rankFromString(m[5]);attackers=attackers.filter(function(sq){return Math.floor(sq/16)===rankFrom})}if(attackers.length===0){var message=m[4]||m[5]?i18n.NO_PIECE_CAN_MOVE_TO_DISAMBIGUATION:i18n.NO_PIECE_CAN_MOVE_TO;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,message,m[3],m[7])}for(var i=0;i<attackers.length;++i){var currentDescriptor=moveGeneration.isKingSafeAfterMove(position,attackers[i],to,-1);if(currentDescriptor){if(descriptor!==null){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.REQUIRE_DISAMBIGUATION,m[3],m[7])}descriptor=currentDescriptor}}if(descriptor===null){var message=position.turn===bt.WHITE?i18n.NOT_SAFE_FOR_WHITE_KING:i18n.NOT_SAFE_FOR_BLACK_KING;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,message)}if(strict){var expectedDS=getDisambiguationSymbol(position,descriptor._from,to);var observedDS=(m[4]?m[4]:"")+(m[5]?m[5]:"");if(expectedDS!==observedDS){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.WRONG_DISAMBIGUATION_SYMBOL,expectedDS,observedDS)}}}else if(m[10]){var to=bt.squareFromString(m[10]);if(m[8]){descriptor=getPawnCaptureDescriptor(position,notation,bt.fileFromString(m[8]),to)}else{descriptor=getPawnAdvanceDescriptor(position,notation,to)}if(!descriptor){var message=position.turn===bt.WHITE?i18n.NOT_SAFE_FOR_WHITE_KING:i18n.NOT_SAFE_FOR_BLACK_KING;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,message)}if(to<8||to>=112){if(!m[12]){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.MISSING_PROMOTION)}var promotion=bt.pieceFromString(m[12].toLowerCase());if(promotion===bt.PAWN||promotion===bt.KING){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_PROMOTED_PIECE,m[12])}descriptor=moveDescriptor.makePromotion(descriptor._from,descriptor._to,descriptor._movingPiece%2,promotion,descriptor._optionalPiece);if(strict&&!m[11]){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.MISSING_PROMOTION_SYMBOL)}}else if(m[12]){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_PROMOTION)}}if(strict){if(descriptor.isCapture()!==(m[6]||m[9])){var message=descriptor.isCapture()?i18n.MISSING_CAPTURE_SYMBOL:i18n.INVALID_CAPTURE_SYMBOL;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,message)}var expectedCCS=getCheckCheckmateSymbol(position,descriptor);var observedCCS=m[13]?m[13]:"";if(expectedCCS!==observedCCS){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.WRONG_CHECK_CHECKMATE_SYMBOL,expectedCCS,observedCCS)}}return descriptor};function getPawnCaptureDescriptor(position,notation,columnFrom,to){var from=to-16+position.turn*32;if((from&136)!==0){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_CAPTURING_PAWN_MOVE)}var columnTo=to%16;if(columnTo-columnFrom===1){from-=1}else if(columnTo-columnFrom===-1){from+=1}else{throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_CAPTURING_PAWN_MOVE)}if(position.board[from]!==bt.PAWN*2+position.turn){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_CAPTURING_PAWN_MOVE)}var toContent=position.board[to];if(toContent<0){if(to===(5-position.turn*3)*16+position.enPassant){return moveGeneration.isKingSafeAfterMove(position,from,to,(4-position.turn)*16+position.enPassant)}}else if(toContent%2!==position.turn){return moveGeneration.isKingSafeAfterMove(position,from,to,-1)}throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_CAPTURING_PAWN_MOVE)}function getPawnAdvanceDescriptor(position,notation,to){var offset=16-position.turn*32;var from=to-offset;if((from&136)!==0){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_NON_CAPTURING_PAWN_MOVE)}if(position.board[to]>=0){throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_NON_CAPTURING_PAWN_MOVE)}var expectedFromContent=bt.PAWN*2+position.turn;if(position.board[from]===expectedFromContent){return moveGeneration.isKingSafeAfterMove(position,from,to,-1)}else if(position.board[from]<0){from-=offset;var firstSquareOfRow=(1+position.turn*5)*16;if(from>=firstSquareOfRow&&from<firstSquareOfRow+8&&position.board[from]===expectedFromContent){return moveGeneration.isKingSafeAfterMove(position,from,to,-1)}}throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_NON_CAPTURING_PAWN_MOVE)}},{"../basetypes":2,"../exception":3,"../i18n":5,"../movedescriptor":6,"./attacks":9,"./fen":10,"./impl":11,"./legality":12,"./movegeneration":13}],15:[function(require,module,exports){"use strict";var bt=require("./basetypes");var exception=require("./exception");exports.forEachSquare=function(fun){for(var rank=0;rank<8;++rank){for(var file=0;file<8;++file){fun(bt.squareToString(rank*16+file))}}};exports.squareColor=function(square){square=bt.squareFromString(square);if(square<0){throw new exception.IllegalArgument("squareColor()")}return Math.floor(square/16)%2===square%2?"b":"w"};exports.squareToCoordinates=function(square){square=bt.squareFromString(square);if(square<0){throw new exception.IllegalArgument("squareToCoordinates()")}return{rank:Math.floor(square/16),file:square%16}};exports.coordinatesToSquare=function(file,rank){if(file<0||file>=8||rank<0||rank>=8){throw new exception.IllegalArgument("coordinatesToSquare()")}return bt.fileToString(file)+bt.rankToString(rank)}},{"./basetypes":2,"./exception":3}]},{},[1])(1)});
